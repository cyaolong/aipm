<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PM Agent - å•†ä¸šäº§å“åŸå‹</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap");

      :root {
        --bg: #f6f4ef;
        --panel: #ffffff;
        --ink: #1f2328;
        --muted: #6b7280;
        --line: #e5e1d8;
        --accent: #0f5d5c;
        --accent-soft: #d9efe9;
        --accent-ink: #ffffff;
        --warn: #f59e0b;
        --danger: #dc2626;
        --success: #16a34a;
        --shadow: 0 18px 40px rgba(31, 35, 40, 0.08);
        --radius: 16px;
      }

      [data-theme="dark"] {
        --bg: #0d1117;
        --panel: #161b22;
        --ink: #f0f6fc;
        --muted: #8b949e;
        --line: #30363d;
        --accent: #188c8a;
        --accent-soft: rgba(24, 140, 138, 0.15);
        --accent-ink: #ffffff;
        --shadow: 0 18px 40px rgba(0, 0, 0, 0.4);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        background: linear-gradient(120deg, #f4f1ea 0%, #f9f7f2 55%, #eef6f3 100%);
        color: var(--ink);
        font-family: "IBM Plex Sans", "PingFang SC", "Hiragino Sans GB", "Noto Sans CJK SC", sans-serif;
        transition: background 0.3s, color 0.3s;
      }
      [data-theme="dark"] body {
        background: linear-gradient(120deg, #0d1117 0%, #161b22 100%);
      }
      header {
        position: sticky;
        top: 0;
        z-index: 10;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--line);
      }
      [data-theme="dark"] header {
        background: rgba(22, 27, 34, 0.8);
      }
      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 24px;
        gap: 16px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        font-family: "Space Grotesk", "IBM Plex Sans", sans-serif;
        font-weight: 600;
        font-size: 18px;
        cursor: pointer;
        color: var(--ink);
      }
      .brand-mark {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: linear-gradient(135deg, #0f5d5c, #0f8f7c);
        color: #fff;
        display: grid;
        place-items: center;
        font-weight: 700;
      }
      .top-actions {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        color: var(--muted);
      }
      .pill {
        background: var(--accent-soft);
        border: 1px solid rgba(15, 93, 92, 0.15);
        padding: 6px 12px;
        border-radius: 999px;
        color: #0f5d5c;
        font-weight: 500;
      }
      .btn {
        border: 1px solid var(--line);
        background: var(--panel);
        color: var(--ink);
        padding: 10px 14px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 14px;
        transition: transform 0.2s ease, border-color 0.2s ease;
      }
      .btn:hover { transform: translateY(-1px); }
      .btn.primary {
        background: var(--accent);
        color: var(--accent-ink);
        border-color: var(--accent);
        font-weight: 600;
      }
      .btn.ghost { background: transparent; }
      .btn.ghost:hover { background: rgba(0,0,0,0.05); }
      [data-theme="dark"] .btn.ghost:hover { background: rgba(255,255,255,0.1); }
      .btn.link {
        border: 0;
        background: transparent;
        color: var(--accent);
        padding: 0;
      }
      .layout {
        display: grid;
        grid-template-columns: 240px 1fr;
        min-height: calc(100vh - 64px);
      }
      nav {
        padding: 20px;
        border-right: 1px solid var(--line);
        background: var(--panel); /* Changed from fixed color to var */
      }
      .nav-title {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.8px;
        color: var(--muted);
        margin: 16px 0 10px;
      }
      .nav-item {
        width: 100%;
        text-align: left;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid transparent;
        background: transparent;
        cursor: pointer;
        font-size: 14px;
        color: var(--ink);
      }
      .nav-item.active {
        border-color: rgba(15, 93, 92, 0.2);
        background: rgba(15, 93, 92, 0.08);
        font-weight: 600;
      }
      .content { padding: 24px; }
      .screen { display: none; }
      .screen.active { display: block; animation: rise 200ms ease-out; }
      .panel {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        padding: 18px;
        box-shadow: var(--shadow);
        margin-bottom: 16px;
      }
      .panel-title {
        font-family: "Space Grotesk", "IBM Plex Sans", sans-serif;
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 10px;
      }
      .row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
      }
      .stack {
        display: grid;
        gap: 12px;
      }
      label {
        font-size: 12px;
        color: var(--muted);
      }
      input, textarea {
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--line);
        background: var(--panel);
        color: var(--ink);
        font-family: inherit;
      }
      textarea { min-height: 56px; resize: vertical; }
      .muted { color: var(--muted); font-size: 13px; }
      .list { display: grid; gap: 10px; }
      .list-item {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .tag {
        border: 1px solid var(--line);
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
      }
      .tag.success { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
      .tag.processing { background: #e0f2fe; color: #075985; border-color: #bae6fd; }

      .segmented {
        display: inline-flex;
        border-radius: 999px;
        border: 1px solid var(--line);
        overflow: hidden;
        background: rgba(0,0,0,0.04); /* Soft background */
      }
      [data-theme="dark"] .segmented {
        background: rgba(255,255,255,0.05);
      }
      .segmented button {
        border: 0;
        background: transparent;
        padding: 8px 14px;
        cursor: pointer;
        color: var(--muted);
      }
      .segmented button.active {
        background: var(--panel);
        color: var(--ink);
        font-weight: 600;
      }
      .helper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
      }
      .state-toggle { display: flex; gap: 8px; flex-wrap: wrap; }
      .empty-box {
        border: 1px dashed var(--line);
        border-radius: 12px;
        padding: 48px;
        text-align: center;
        color: var(--muted);
        background: rgba(0,0,0,0.02);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
      }
      .progress {
        height: 10px;
        background: var(--line);
        border-radius: 999px;
        overflow: hidden;
      }
      .progress span {
        display: block;
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--accent), #3aa58a);
        transition: width 0.3s ease;
      }
      .cards {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
      .card {
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 14px;
        background: var(--panel);
      }
      .card h4 { margin: 0 0 6px; font-family: "Space Grotesk", sans-serif; }
      .card p { margin: 0 0 12px; color: var(--muted); font-size: 13px; }
      .footer-actions { display: flex; gap: 10px; justify-content: flex-end; }
      .grid-two { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
      .hidden { display: none !important; }
      .doc h3 { margin: 18px 0 8px; font-size: 16px; }
      .doc p { margin: 0 0 10px; color: var(--ink); }
      .doc ul { margin: 0 0 12px 18px; }
      .doc li { margin-bottom: 6px; color: var(--ink); }
      .doc .muted { color: var(--muted); }
      .overlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.2);
        backdrop-filter: blur(8px);
        z-index: 20;
      }
      .overlay.active { display: flex; }
      .modal {
        width: min(420px, 92vw);
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 18px;
        box-shadow: var(--shadow);
      }
      @keyframes rise {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @media (max-width: 980px) {
        .layout { grid-template-columns: 1fr; }
        nav { border-right: 0; border-bottom: 1px solid var(--line); }
        .grid-two { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="topbar">
        <div class="brand" onclick="setActiveScreen('dashboard')"><span class="brand-mark">PM</span>PM Agent</div>
        <div class="top-actions" id="top-actions">
          <span class="pill" id="token-pill">Token ä½™é¢ï¼š<strong id="token-balance">1000</strong></span>
          <button class="btn" data-screen="subscription">è®¢é˜…ä¸é¢åº¦</button>
          <button class="btn ghost" id="theme-toggle" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ—</button>
          <button class="btn ghost" id="logout">é€€å‡º</button>
        </div>
      </div>
    </header>

    <div class="content" id="auth-view">
      <div class="panel" style="max-width: 640px; margin: 32px auto;">
        <div class="panel-title">PM Agent - æ¬¢è¿</div>
        <p class="muted">AI é©±åŠ¨çš„äº§å“ç»ç†å·¥ä½œå°ã€‚è¾“å…¥ Ideaï¼Œè‡ªåŠ¨ç”Ÿæˆ PRD ä¸å¯äº¤äº’åŸå‹ã€‚</p>
        <div class="segmented" role="tablist" aria-label="ç™»å½•æ–¹å¼">
          <button class="active" data-tab-group="auth" data-tab="login">ç™»å½•</button>
          <button data-tab-group="auth" data-tab="register">æ³¨å†Œ</button>
        </div>

        <div class="panel" data-tab-panel-group="auth" data-tab-panel="login" style="margin-top: 12px;">
          <div class="stack">
            <div>
              <label>é‚®ç®±</label>
              <input type="email" value="demo@pmagent.ai" />
            </div>
            <div>
              <label>å¯†ç </label>
              <input type="password" value="123456" />
            </div>
          </div>
          <div class="footer-actions" style="margin-top: 12px;">
            <button class="btn primary" id="login-btn">è¿›å…¥å·¥ä½œå°</button>
          </div>
          
          <div style="margin-top: 24px; text-align: center; position: relative;">
            <hr style="border: 0; border-top: 1px solid var(--line); position: absolute; top: 50%; width: 100%; z-index: 0;">
            <span style="background: #fff; padding: 0 10px; position: relative; z-index: 1; color: var(--muted); font-size: 12px;">æˆ–è€…</span>
          </div>

          <div style="margin-top: 16px; display: flex; justify-content: center;">
            <!-- Google Sign-In Configuration -->
            <!-- 
                 TODO: æ›¿æ¢ client_id ä¸ºä½ è‡ªå·±åœ¨ Google Cloud Console ç”³è¯·çš„ ID
                 1. console.cloud.google.com -> API & Services -> Credentials
                 2. Create OAuth Client ID (Web application)
                 3. Authorized Origins: http://localhost:8000
            -->
            <div id="g_id_onload"
                 data-client_id="YOUR_GOOGLE_CLIENT_ID"
                 data-context="signin"
                 data-ux_mode="popup"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false">
            </div>

            <div class="g_id_signin"
                 data-type="standard"
                 data-shape="rectangular"
                 data-theme="outline"
                 data-text="sign_in_with"
                 data-size="large"
                 data-logo_alignment="left">
            </div>
          </div>
        </div>
      </div>
    </div>

    <main class="layout hidden" id="app-shell">
      <nav>
        <div class="nav-title">å·¥ä½œæµ</div>
        <button class="nav-item active" data-screen="dashboard">å·¥ä½œå°</button>
        <button class="nav-item" data-screen="new-project">æ–°å»ºé¡¹ç›®</button>
        <div class="nav-title">æœ€è¿‘é¡¹ç›®</div>
        <div id="nav-recent-projects">
          <!-- Populated by JS -->
        </div>
        <div class="nav-title">è´¦æˆ·</div>
        <button class="nav-item" data-screen="subscription">è®¢é˜…ä¸é¢åº¦</button>
      </nav>
      
      <div class="content">
        <!-- SCREEN: DASHBOARD -->
        <section class="screen active" id="dashboard">
          <div class="panel">
            <div class="panel-title">æˆ‘çš„é¡¹ç›®</div>
            <div id="project-list-container" class="list">
              <!-- Populated by JS -->
            </div>
            <div id="project-empty-state" class="empty-box hidden">
              <div>ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ PM Agent</div>
              <p>ä½ è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•é¡¹ç›®ã€‚ä»ä¸€ä¸ªç®€å•çš„ Idea å¼€å§‹å§ã€‚</p>
              <button class="btn primary" data-screen="new-project">å¼€å§‹æ–°å»º</button>
            </div>
          </div>
        </section>

        <!-- SCREEN: NEW PROJECT -->
        <section class="screen" id="new-project">
          <div class="grid-two">
            <div class="panel">
              <div class="panel-title">æ–°å»ºé¡¹ç›®</div>
              <div>
                <label>ä½ çš„ Idea æ˜¯ä»€ä¹ˆï¼Ÿ</label>
                <textarea id="idea-input" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³åšä¸€ä¸ªé’ˆå¯¹è‡ªç”±èŒä¸šè€…çš„ç¨åŠ¡ç”³æŠ¥åŠ©æ‰‹ï¼Œèƒ½å¤Ÿè‡ªåŠ¨æ‰«æå‘ç¥¨å¹¶è®¡ç®—é¢„ä¼°ç¨é¢..."></textarea>
              </div>
              <div style="margin-top: 10px;">
                <label>ç›®æ ‡ç”¨æˆ·ï¼ˆå¯é€‰ï¼‰</label>
                <input id="context-user" placeholder="ä¾‹å¦‚ï¼šä¸­å°å›¢é˜Ÿäº§å“ç»ç† / åˆ›ä¸š PM" />
              </div>
              <div style="margin-top: 10px;">
                <label>ç«å“ï¼ˆå¯é€‰ï¼‰</label>
                <input id="context-competitors" placeholder="ä¾‹å¦‚ï¼šé€šç”¨ LLM / æ–‡æ¡£æ¨¡æ¿å·¥å…· / åŸå‹å·¥å…·" />
              </div>
              <div style="margin-top: 10px;">
                <label>æ ¸å¿ƒå•†ä¸šç›®æ ‡ï¼ˆå¯é€‰ï¼‰</label>
                <input id="context-goal" placeholder="ä¾‹å¦‚ï¼šè¥æ”¶ / å¢é•¿ / æ•ˆç‡ / åˆè§„" />
              </div>
              <div class="footer-actions" style="margin-top: 20px;">
                <button class="btn" data-screen="dashboard">å–æ¶ˆ</button>
                <button class="btn primary" id="generate-btn">ç”Ÿæˆæ–¹æ¡ˆ (æ¶ˆè€— 10 Token)</button>
              </div>
            </div>
            <div class="panel">
              <div class="panel-title">å·¥ä½œæµé¢„è§ˆ</div>
              <div class="list">
                <div class="list-item">
                  <span class="muted">1. å®Œå–„æ„æƒ³ (Idea Enhancement)</span>
                </div>
                <div class="list-item">
                  <span class="muted">2. ç”Ÿæˆ PRD (MVP Scope)</span>
                </div>
                <div class="list-item">
                  <span class="muted">3. äº§å‡ºæœ¬åœ°äº¤äº’åŸå‹ (HTML)</span>
                </div>
              </div>
              <div class="panel" style="background: #f5faf8; border-color: #d6e9e3; margin-top: 12px;">
                <p class="muted">å½“å‰å‰©ä½™å…è´¹ Token: <strong id="token-display-mini">1000</strong></p>
              </div>
            </div>
          </div>
        </section>

        <!-- SCREEN: RESULTS (IDEA & PRD) -->
        <section class="screen" id="results">
          <div class="panel">
            <div class="panel-title" style="display:flex; justify-content:space-between;">
              <span id="result-project-title">é¡¹ç›®è¯¦æƒ…</span>
              <span class="tag processing" id="result-status-tag">ç”Ÿæˆä¸­...</span>
            </div>
            
            <div id="generation-progress" class="panel hidden" style="background:#f9fafb;">
               <p class="muted" id="progress-text">æ­£åœ¨åˆ†æä½ çš„ Idea...</p>
               <div class="progress"><span id="progress-bar" style="width: 0%"></span></div>
            </div>

            <div id="result-content" class="hidden">
              <div class="segmented" role="tablist" style="margin: 12px 0;">
                <button class="active" data-tab-group="results" data-tab="idea">1. å®Œå–„æ„æƒ³</button>
                <button data-tab-group="results" data-tab="prd">2. PRD æ–‡æ¡£</button>
                <button data-tab-group="results" data-tab="prototype">3. åŸå‹</button>
              </div>

              <!-- TAB: IDEA -->
              <div data-tab-panel-group="results" data-tab-panel="idea">
                <div class="panel doc" style="border:0; shadow:none; padding:0;">
                  <div id="idea-doc"></div>
                </div>
              </div>

              <!-- TAB: PRD -->
              <div class="hidden" data-tab-panel-group="results" data-tab-panel="prd">
                <div class="panel doc" style="border:0; shadow:none; padding:0;">
                  <div id="prd-doc"></div>
                </div>
              </div>

              <!-- TAB: PROTOTYPE -->
              <div class="hidden" data-tab-panel-group="results" data-tab-panel="prototype">
                 <div class="empty-box">
                    <div style="font-size: 48px; margin-bottom: 10px;">âš¡ï¸</div>
                    <div>æœ¬åœ°åŸå‹å·²å°±ç»ª</div>
                    <p class="muted">å·²ç”Ÿæˆå¯è¿è¡Œçš„åŸå‹ HTMLã€‚<br>æ–‡ä»¶åï¼š<code id="prototype-file">prototype.html</code></p>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                      <button class="btn primary" id="prototype-open">æ‰“å¼€é¢„è§ˆ</button>
                      <button class="btn" id="prototype-download">ä¸‹è½½åŸå‹</button>
                    </div>
                 </div>
              </div>
            </div>
            
          </div>
        </section>

        <!-- SCREEN: SUBSCRIPTION -->
        <section class="screen" id="subscription">
          <div class="panel">
            <div class="panel-title">è®¢é˜…è®¡åˆ’</div>
            <div class="cards">
              <div class="card">
                <h4>æœˆåº¦ä¼šå‘˜</h4>
                <p>ï¿¥20 / æœˆ</p>
                <button class="btn primary">è®¢é˜…</button>
              </div>
              <div class="card">
                <h4>å¹´åº¦ä¼šå‘˜</h4>
                <p>ï¿¥120 / å¹´ (ç«‹çœ 50%)</p>
                <button class="btn primary">è®¢é˜…</button>
              </div>
            </div>
          </div>
          <div class="panel">
            <div class="panel-title">Token ä½¿ç”¨è®°å½•</div>
            <div class="list">
              <div class="list-item">
                <span>ç”Ÿæˆé¡¹ç›®ï¼šç¨åŠ¡åŠ©æ‰‹</span>
                <span class="muted">-10 Token</span>
              </div>
              <div class="list-item">
                <span>åˆå§‹èµ é€</span>
                <span class="tag success">+1000 Token</span>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <div class="overlay" id="paywall">
      <div class="modal">
        <h3>é¢åº¦ä¸è¶³</h3>
        <p class="muted">ä½ çš„å…è´¹ Token å·²ç”¨å°½ï¼Œè¯·è®¢é˜…åç»§ç»­ç”Ÿæˆã€‚</p>
        <div class="footer-actions" style="margin-top: 12px;">
          <button class="btn" data-close="paywall">å–æ¶ˆ</button>
          <button class="btn primary" data-screen="subscription">å»è®¢é˜…</button>
        </div>
      </div>
    </div>

    <script>
      // Data State
      let state = {
        user: null,
        tokenBalance: 1000,
        projects: [
          {
            id: 2,
            title: 'æ™ºèƒ½ç¨åŠ¡ç®¡ç†å·¥å…·',
            desc: 'é¢å‘è‡ªç”±èŒä¸šè€…çš„ç¨åŠ¡æ•´ç†ä¸ç”³æŠ¥åŠ©æ‰‹',
            status: 'completed',
            date: '2023-10-23 19:20',
            ideaInput: 'æ™ºèƒ½ç¨åŠ¡ç®¡ç†å·¥å…·',
            context: {
              user: 'è‡ªç”±èŒä¸šè€…ã€ä¸ªä½“æˆ·ã€å°å¾®å•†å®¶',
              competitors: 'è®°è´¦è½¯ä»¶ã€ç”µå­å‘ç¥¨ç®¡ç†å·¥å…·ã€ä»£ç†è®°è´¦æœåŠ¡',
              goal: 'åˆè§„ä¸æ•ˆç‡'
            }
          }
        ]
      };

      // Elements
      const navItems = document.querySelectorAll('[data-screen]');
      const screens = document.querySelectorAll('.screen');
      const tokenDisplay = document.getElementById('token-balance');
      const tokenDisplayMini = document.getElementById('token-display-mini');
      const paywall = document.getElementById('paywall');
      const authView = document.getElementById('auth-view');
      const appShell = document.getElementById('app-shell');
      const topActions = document.getElementById('top-actions');
      const projectListEl = document.getElementById('project-list-container');
      const emptyStateEl = document.getElementById('project-empty-state');
      const navRecentEl = document.getElementById('nav-recent-projects');
      const ideaDocEl = document.getElementById('idea-doc');
      const prdDocEl = document.getElementById('prd-doc');
      const prototypeFileEl = document.getElementById('prototype-file');
      const prototypeOpenBtn = document.getElementById('prototype-open');
      const prototypeDownloadBtn = document.getElementById('prototype-download');

      function escapeHtml(value) {
        return String(value || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/\"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function shortIdea(idea) {
        const clean = (idea || '').trim();
        if (!clean) return 'è¯¥æƒ³æ³•';
        return clean.length > 24 ? `${clean.slice(0, 24)}...` : clean;
      }

      function slugify(value) {
        const clean = (value || '').toLowerCase();
        const ascii = clean.replace(/[^a-z0-9\u4e00-\u9fa5]+/g, '-');
        return ascii.replace(/^-+|-+$/g, '') || 'prototype';
      }

      function buildPrototypeHtml(project) {
        const idea = project.ideaInput || 'æ™ºèƒ½ç¨åŠ¡ç®¡ç†å·¥å…·';
        const title = escapeHtml(shortIdea(idea));
        const isTax = isTaxIdea(idea);
        if (isTax) {
          return `<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>${title} - åŸå‹</title>
    <style>
      :root { --bg:#f8f5ef; --panel:#fff; --ink:#1f2328; --muted:#6b7280; --accent:#0f5d5c; --line:#e5e1d8; }
      *{box-sizing:border-box} body{margin:0;font-family:Arial,\"PingFang SC\",sans-serif;background:var(--bg);color:var(--ink)}
      header{padding:16px 20px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0}
      .layout{display:grid;grid-template-columns:220px 1fr;min-height:100vh}
      nav{border-right:1px solid var(--line);background:#fff;padding:16px}
      nav button{width:100%;text-align:left;margin-bottom:8px;padding:10px;border:1px solid transparent;border-radius:10px;background:#fff;cursor:pointer}
      nav button.active{border-color:rgba(15,93,92,.25);background:rgba(15,93,92,.08)}
      main{padding:20px}
      .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px;margin-bottom:16px}
      .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
      .muted{color:var(--muted);font-size:13px}
      .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
      .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
      .hidden{display:none}
      .list{display:grid;gap:8px}
      .list-item{border:1px solid var(--line);border-radius:10px;padding:10px}
    </style>
  </head>
  <body>
    <header><strong>${title}</strong> <span class="muted">ç¨åŠ¡ç”³æŠ¥æµç¨‹åŸå‹</span></header>
    <div class="layout">
      <nav>
        <button class="active" data-screen="overview">æ€»è§ˆ</button>
        <button data-screen="receipts">ç¥¨æ®æ•´ç†</button>
        <button data-screen="estimate">ç¨é¢é¢„ä¼°</button>
        <button data-screen="draft">ç”³æŠ¥è‰ç¨¿</button>
      </nav>
      <main>
        <section id="overview" class="panel">
          <h3>æœ¬æœŸæ¦‚è§ˆ</h3>
          <div class="grid">
            <div class="panel">
              <div class="muted">å·²è¯†åˆ«ç¥¨æ®</div>
              <strong>18 å¼ </strong>
            </div>
            <div class="panel">
              <div class="muted">é¢„ä¼°ç¨é¢</div>
              <strong>Â¥ 6,420</strong>
            </div>
            <div class="panel">
              <div class="muted">ç”³æŠ¥çŠ¶æ€</div>
              <strong>å¾…ç”Ÿæˆè‰ç¨¿</strong>
            </div>
          </div>
          <div style="margin-top:12px;">
            <button class="btn primary" data-screen="receipts">å¼€å§‹æ•´ç†ç¥¨æ®</button>
          </div>
        </section>

        <section id="receipts" class="panel hidden">
          <h3>ç¥¨æ®æ•´ç†</h3>
          <p class="muted">ä¸Šä¼ æˆ–å½•å…¥ç¥¨æ®ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ†ç±»å¹¶æç¤ºå¼‚å¸¸ã€‚</p>
          <div class="list">
            <div class="list-item">å‘ç¥¨ï¼š18 å¼  / Â¥ 52,340</div>
            <div class="list-item">å¾…è¡¥å……ï¼šäº¤é€šè´¹ç¥¨æ® 2 å¼ </div>
          </div>
          <div style="margin-top:12px;">
            <button class="btn primary" data-screen="estimate">ç”Ÿæˆç¨é¢é¢„ä¼°</button>
          </div>
        </section>

        <section id="estimate" class="panel hidden">
          <h3>ç¨é¢é¢„ä¼°</h3>
          <div class="list">
            <div class="list-item">æœ¬æœŸé¢„ä¼°ç¨é¢ï¼šÂ¥ 6,420</div>
            <div class="list-item">å¯æŠµæ‰£æˆæœ¬ï¼šÂ¥ 12,800</div>
            <div class="list-item">é£é™©æç¤ºï¼šå‘ç¥¨é‡å¤å½•å…¥ 1 æ¡</div>
          </div>
          <div style="margin-top:12px;">
            <button class="btn primary" data-screen="draft">ç”Ÿæˆç”³æŠ¥è‰ç¨¿</button>
          </div>
        </section>

        <section id="draft" class="panel hidden">
          <h3>ç”³æŠ¥è‰ç¨¿</h3>
          <p class="muted">è‰ç¨¿å·²ç”Ÿæˆï¼Œå¯ä¸‹è½½æˆ–å¯¼å‡ºã€‚</p>
          <div class="list">
            <div class="list-item">è‰ç¨¿ç‰ˆæœ¬ï¼š2024Q4</div>
            <div class="list-item">å¯¼å‡ºæ ¼å¼ï¼šPDF / Excel</div>
          </div>
          <div style="margin-top:12px;">
            <button class="btn">ä¸‹è½½è‰ç¨¿</button>
          </div>
        </section>
      </main>
    </div>
    <script>
      const buttons = document.querySelectorAll('nav button, [data-screen]');
      const screens = document.querySelectorAll('main section');
      function showScreen(id){
        screens.forEach(s => s.classList.toggle('hidden', s.id !== id));
        document.querySelectorAll('nav button').forEach(b => b.classList.toggle('active', b.dataset.screen === id));
      }
      buttons.forEach(btn => btn.addEventListener('click', () => showScreen(btn.dataset.screen)));
    ${'</scr' + 'ipt>'}
  </body>
</html>`;
        }

        return `<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>${title} - åŸå‹</title>
    <style>
      body{margin:0;font-family:Arial,\"PingFang SC\",sans-serif;background:#f6f4ef;color:#1f2328}
      header{padding:16px 20px;border-bottom:1px solid #e5e1d8;background:#fff}
      main{padding:20px}
      .panel{background:#fff;border:1px solid #e5e1d8;border-radius:12px;padding:16px;margin-bottom:12px}
      .muted{color:#6b7280;font-size:13px}
      .btn{padding:10px 14px;border-radius:10px;border:1px solid #e5e1d8;background:#fff}
    </style>
  </head>
  <body>
    <header><strong>${title}</strong> <span class="muted">é€šç”¨æµç¨‹åŸå‹</span></header>
    <main>
      <div class="panel">
        <h3>æµç¨‹æ¦‚è§ˆ</h3>
        <p class="muted">è¾“å…¥å…³é”®ä¿¡æ¯ â†’ ç”Ÿæˆç»“æ„åŒ–å†…å®¹ â†’ è¾“å‡ºå¯äº¤ä»˜ç»“æœã€‚</p>
        <button class="btn">å¼€å§‹</button>
      </div>
    </main>
  </body>
</html>`;
      }

      function ensurePrototype(project) {
        if (!project) return;
        if (project.prototype && project.prototype.url) return;
        const fileName = `${slugify(project.title || project.ideaInput)}.html`;
        const html = buildPrototypeHtml(project);
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        project.prototype = { fileName, url, html };
      }

      function updatePrototypeUI(project) {
        if (!project) return;
        ensurePrototype(project);
        if (prototypeFileEl) prototypeFileEl.textContent = project.prototype.fileName;
        if (prototypeOpenBtn) {
          prototypeOpenBtn.onclick = () => window.open(project.prototype.url, '_blank');
        }
        if (prototypeDownloadBtn) {
          prototypeDownloadBtn.onclick = () => {
            const link = document.createElement('a');
            link.href = project.prototype.url;
            link.download = project.prototype.fileName;
            document.body.appendChild(link);
            link.click();
            link.remove();
          };
        }
      }

      function isTaxIdea(idea) {
        return /ç¨|ç¨åŠ¡|ç”³æŠ¥|å‘ç¥¨|ä¸ªä½“æˆ·|çº³ç¨|è´¢ç¨|æŠ¥ç¨/.test(idea || '');
      }

      function buildIdeaEnhanced(project) {
        const idea = project.ideaInput || '';
        const user = project.context && project.context.user ? project.context.user : 'å¾…è¡¥å……';
        const competitors = project.context && project.context.competitors ? project.context.competitors : 'å¾…è°ƒç ”';
        const shortText = escapeHtml(shortIdea(idea));

        if (isTaxIdea(idea)) {
          const taxUser = user === 'å¾…è¡¥å……' ? 'è‡ªç”±èŒä¸šè€…ã€ä¸ªä½“æˆ·ã€å°å¾®å•†å®¶' : user;
          const taxCompetitors = competitors === 'å¾…è°ƒç ”' ? 'è®°è´¦è½¯ä»¶ã€ç”µå­å‘ç¥¨ç®¡ç†å·¥å…·ã€ä»£ç†è®°è´¦æœåŠ¡' : competitors;
          return `
            <h3>ä¸€å¥è¯å®šä½</h3>
            <p class="muted">é¢å‘${escapeHtml(taxUser)}çš„æ™ºèƒ½ç¨åŠ¡ç®¡ç†å·¥å…·ï¼šç¥¨æ®æ•´ç†ã€ç¨é¢é¢„ä¼°ã€ç”³æŠ¥è‰ç¨¿ä¸æé†’ä¸€ä½“åŒ–å®Œæˆã€‚</p>

            <h3>ç›®æ ‡ç”¨æˆ·ä¸åœºæ™¯</h3>
            <ul>
              <li>ç›®æ ‡ç”¨æˆ·ï¼š${escapeHtml(taxUser)}</li>
              <li>æ ¸å¿ƒåœºæ™¯ï¼šç”³æŠ¥æœŸå‰å¿«é€Ÿæ•´ç†ç¥¨æ®ã€ä¼°ç®—ç¨é¢å¹¶ç”Ÿæˆç”³æŠ¥è‰ç¨¿ã€‚</li>
            </ul>

            <h3>å¸‚åœºå®šä½</h3>
            <p class="muted">å®šä½ä¸ºâ€œè½»é‡ç¨åŠ¡ç”³æŠ¥å·¥ä½œæµå·¥å…·â€ï¼Œä»‹äºè®°è´¦è½¯ä»¶ä¸ä»£ç†è®°è´¦æœåŠ¡ä¹‹é—´ã€‚</p>

            <h3>ç«å“ä¸å·®å¼‚åŒ–</h3>
            <ul>
              <li>ç«å“ï¼š${escapeHtml(taxCompetitors)}</li>
              <li>å·®å¼‚åŒ–ï¼šç”³æŠ¥æµç¨‹å¼•å¯¼ + é¢„ä¼°ç¨é¢ + è‰ç¨¿å¯¼å‡º + ç”³æŠ¥æé†’ã€‚</li>
            </ul>

            <h3>ä»·å€¼ä¸»å¼ </h3>
            <ul>
              <li>çœæ—¶ï¼šå‡å°‘ç¥¨æ®æ•´ç†ä¸ç”³æŠ¥å‡†å¤‡çš„æ—¶é—´æˆæœ¬ã€‚</li>
              <li>åˆè§„ï¼šææ–™æ¸…å•ä¸é£é™©æç¤ºé™ä½é—æ¼ç‡ã€‚</li>
            </ul>

            <h3>æ ¸å¿ƒåœºæ™¯ä¸è·¯å¾„</h3>
            <ul>
              <li>1) ç™»å½• â†’ é…ç½®ç¨åŠ¡èº«ä»½</li>
              <li>2) ä¸Šä¼ /å½•å…¥ç¥¨æ® â†’ è‡ªåŠ¨åˆ†ç±»ä¸æ ¡éªŒ</li>
              <li>3) ç”Ÿæˆç¨é¢é¢„ä¼° â†’ å¯¼å‡ºç”³æŠ¥è‰ç¨¿</li>
            </ul>

            <h3>MVP èŒƒå›´</h3>
            <ul>
              <li>åšï¼šç¥¨æ®ç®¡ç†ã€ç¨é¢é¢„ä¼°ã€ç”³æŠ¥è‰ç¨¿å¯¼å‡ºã€æé†’ä¸è®¢é˜…ã€‚</li>
              <li>ä¸åšï¼šå¤šç¨åˆ¶æ·±åº¦é€‚é…ã€ä»£æŠ¥æœåŠ¡ã€å¤æ‚è´¢åŠ¡åˆ†æã€‚</li>
            </ul>

            <h3>å…³é”®å‡è®¾ä¸å¾…éªŒè¯</h3>
            <ul>
              <li>ç”¨æˆ·æ„¿æ„ä¸ºâ€œç”³æŠ¥æ•ˆç‡ + åˆè§„æé†’â€ä»˜è´¹ã€‚</li>
              <li>ç¨é¢é¢„ä¼°å‡†ç¡®åº¦è¾¾åˆ°å¯ç”¨é—¨æ§›ã€‚</li>
            </ul>
          `;
        }

        return `
          <h3>ä¸€å¥è¯å®šä½</h3>
          <p class="muted">é¢å‘${escapeHtml(user)}çš„è§£å†³æ–¹æ¡ˆï¼šå›´ç»•â€œ${shortText}â€æä¾›ç«¯åˆ°ç«¯æµç¨‹èƒ½åŠ›ã€‚</p>

          <h3>ç›®æ ‡ç”¨æˆ·ä¸åœºæ™¯</h3>
          <ul>
            <li>ç›®æ ‡ç”¨æˆ·ï¼š${escapeHtml(user)}</li>
            <li>æ ¸å¿ƒåœºæ™¯ï¼šç”¨æˆ·åœ¨ç‰¹å®šåœºæ™¯ä¸‹éœ€è¦â€œ${shortText}â€çš„èƒ½åŠ›æ”¯æŒã€‚</li>
          </ul>

          <h3>å¸‚åœºå®šä½</h3>
          <p class="muted">å®šä½ä¸ºèšç„¦â€œ${shortText}â€çš„å‚ç›´å·¥å…·ï¼Œå¼ºè°ƒå¯æ‰§è¡Œä¸å¯äº¤ä»˜ã€‚</p>

          <h3>ç«å“ä¸å·®å¼‚åŒ–</h3>
          <ul>
            <li>ç«å“ï¼š${escapeHtml(competitors)}</li>
            <li>å·®å¼‚åŒ–ï¼šå›´ç»•â€œ${shortText}â€æä¾›å®Œæ•´æµç¨‹ä¸æ˜ç¡®è¾“å‡ºã€‚</li>
          </ul>

          <h3>ä»·å€¼ä¸»å¼ </h3>
          <ul>
            <li>æ•ˆç‡ï¼šå‡å°‘ä»æƒ³æ³•åˆ°æˆæœçš„æ—¶é—´æˆæœ¬ã€‚</li>
            <li>ç¡®å®šæ€§ï¼šæ ‡å‡†åŒ–äº§å‡ºï¼Œæé«˜æ²Ÿé€šä¸åä½œæ•ˆç‡ã€‚</li>
          </ul>

          <h3>æ ¸å¿ƒåœºæ™¯ä¸è·¯å¾„</h3>
          <ul>
            <li>1) ç”¨æˆ·è¿›å…¥äº§å“ â†’ å®Œæˆå…³é”®ä¿¡æ¯è¾“å…¥</li>
            <li>2) ç³»ç»Ÿç”Ÿæˆç»“æ„åŒ–å†…å®¹ â†’ ç”¨æˆ·å¿«é€Ÿç¡®è®¤</li>
            <li>3) è¾“å‡ºå¯äº¤ä»˜ç»“æœ â†’ åˆ†äº«ä¸åä½œ</li>
          </ul>

          <h3>MVP èŒƒå›´</h3>
          <ul>
            <li>åšï¼šå›´ç»•â€œ${shortText}â€çš„æ ¸å¿ƒæµç¨‹ä¸å…³é”®è¾“å‡ºã€‚</li>
            <li>ä¸åšï¼šå¤æ‚åä½œã€é«˜çº§åˆ†æã€å¤šç«¯é‡æ„ã€‚</li>
          </ul>

          <h3>å…³é”®å‡è®¾ä¸å¾…éªŒè¯</h3>
          <ul>
            <li>ç›®æ ‡ç”¨æˆ·å¯¹â€œ${shortText}â€æœ‰é«˜é¢‘éœ€æ±‚ã€‚</li>
            <li>ç”¨æˆ·æ„¿æ„ä¸ºæ•ˆç‡ä¸ç»“æœä»˜è´¹ã€‚</li>
          </ul>
        `;
      }

      function buildPrd(project) {
        const idea = project.ideaInput || '';
        const user = project.context && project.context.user ? project.context.user : 'å¾…è¡¥å……';
        const goal = project.context && project.context.goal ? project.context.goal : 'å¾…æ˜ç¡®';
        const shortText = escapeHtml(shortIdea(idea));

        if (isTaxIdea(idea)) {
          const taxUser = user === 'å¾…è¡¥å……' ? 'è‡ªç”±èŒä¸šè€…ã€ä¸ªä½“æˆ·ã€å°å¾®å•†å®¶' : user;
          return `
            <h3>éœ€æ±‚èƒŒæ™¯</h3>
            <p class="muted">è‡ªç”±èŒä¸šè€…ä¸ä¸ªä½“æˆ·åœ¨ç”³æŠ¥å­£éœ€è¦æ•´ç†ç¥¨æ®ã€ä¼°ç®—ç¨é¢å¹¶å®Œæˆç”³æŠ¥ï¼Œæµç¨‹åˆ†æ•£ã€å®¹æ˜“é—æ¼ã€‚</p>

            <h3>é¡¹ç›®å®šä½åŠå‘å±•æ–¹å‘</h3>
            <ul>
              <li>å®šä½ï¼šé¢å‘${escapeHtml(taxUser)}çš„ç¨åŠ¡ç”³æŠ¥å·¥ä½œæµå·¥å…·ã€‚</li>
              <li>å‘å±•æ–¹å‘ï¼šä»å•ä¸€ç¨åˆ¶æ‰©å±•åˆ°å¤šåœ°åŒºä¸è¡Œä¸šæ¨¡æ¿ã€‚</li>
            </ul>

            <h3>ç›®æ ‡ä¸æŒ‡æ ‡ï¼ˆå£å¾„ï¼‰</h3>
            <ul>
              <li>åŒ—ææ˜ŸæŒ‡æ ‡ï¼šç”³æŠ¥å®Œæˆç‡ï¼ˆç”Ÿæˆè‰ç¨¿å¹¶æ ‡è®°å®Œæˆï¼‰ã€‚</li>
              <li>æ ¸å¿ƒæŒ‡æ ‡ï¼ˆ1-3 ä¸ªï¼‰ï¼šæœˆæ´» â‰¥ 200ï¼›è‰ç¨¿ç”ŸæˆæˆåŠŸç‡ â‰¥ 70%ï¼›ä»˜è´¹è½¬åŒ–ç‡ â‰¥ 5%ã€‚</li>
              <li>KPI ç»´åº¦æ‹†è§£ï¼ˆç¤ºä¾‹ï¼‰ï¼šå¢é•¿ / è½¬åŒ– / ç•™å­˜ / æ´»è·ƒ / æ”¶å…¥æˆæœ¬ã€‚</li>
              <li>å£å¾„è¯´æ˜ï¼šç”³æŠ¥æœŸå†…å®Œæˆè‰ç¨¿ç”Ÿæˆå¹¶æ ‡è®°å®Œæˆã€‚</li>
            </ul>

            <h3>éœ€æ±‚å¯è¡Œæ€§</h3>
            <ul>
              <li>æŠ€æœ¯å¯è¡Œï¼šç¥¨æ® OCR + åˆ†ç±»ä¸ç¨ç‡é…ç½®å¯æ»¡è¶³ MVPã€‚</li>
              <li>èµ„æºå¯è¡Œï¼šå…ˆèšç„¦å•ç¨åˆ¶ä¸å•åœ°åŒºã€‚</li>
            </ul>

            <h3>ç›®æ ‡ç”¨æˆ·ä¸æ ¸å¿ƒåœºæ™¯</h3>
            <ul>
              <li>ç›®æ ‡ç”¨æˆ·ï¼š${escapeHtml(taxUser)}</li>
              <li>æ ¸å¿ƒåœºæ™¯ï¼šç¥¨æ®æ•´ç† â†’ ç¨é¢é¢„ä¼° â†’ ç”³æŠ¥è‰ç¨¿å¯¼å‡ºã€‚</li>
            </ul>

            <h3>MVP éœ€æ±‚èŒƒå›´</h3>
            <ul>
              <li>åšï¼šèº«ä»½é…ç½®ã€ç¥¨æ®ç®¡ç†ã€ç¨é¢é¢„ä¼°ã€è‰ç¨¿å¯¼å‡ºã€ç”³æŠ¥æé†’ã€‚</li>
              <li>ä¸åšï¼šå¤šåœ°åŒºç¨åˆ¶æ·±åº¦é€‚é…ã€ä»£æŠ¥æœåŠ¡ã€å¤æ‚è®°è´¦åˆ†æã€‚</li>
            </ul>

            <h3>æ ¸å¿ƒæµç¨‹ä¸åŠŸèƒ½éœ€æ±‚</h3>
            <ul>
              <li>æµç¨‹é—­ç¯ï¼šç™»å½• â†’ é…ç½®èº«ä»½ â†’ ä¸Šä¼ ç¥¨æ® â†’ ç¨é¢é¢„ä¼° â†’ è‰ç¨¿å¯¼å‡ºã€‚</li>
              <li>åŠŸèƒ½éœ€æ±‚ï¼šç¥¨æ®è¯†åˆ«ä¸åˆ†ç±»ã€é¢„ä¼°è®¡ç®—ã€è‰ç¨¿ä¸‹è½½ã€æé†’è®¾ç½®ã€‚</li>
            </ul>

            <h3>UI ä¸äº¤äº’éœ€æ±‚ï¼ˆiOS ç»„ä»¶åº“ï¼‰</h3>
            <p class="muted">åˆ†æ­¥å±•ç¤ºï¼ˆç¥¨æ® â†’ é¢„ä¼° â†’ è‰ç¨¿ï¼‰ï¼Œè¦†ç›–ä¸Šä¼ ä¸­/è¯†åˆ«å¤±è´¥/ç”ŸæˆæˆåŠŸçŠ¶æ€ã€‚</p>

            <h3>ç‰ˆæœ¬è§„åˆ’ä¸é‡Œç¨‹ç¢‘</h3>
            <ul>
              <li>V0ï¼ˆMVPï¼‰èŒƒå›´ï¼šç¥¨æ®ç®¡ç† + é¢„ä¼° + è‰ç¨¿å¯¼å‡ºã€‚</li>
              <li>V1ï¼ˆæ‰©å±•ï¼‰èŒƒå›´ï¼šç¨åˆ¶æ‰©å±•ä¸è¡Œä¸šæ¨¡æ¿ã€‚</li>
              <li>é‡Œç¨‹ç¢‘ï¼šD1 æ ¸å¿ƒæµç¨‹ï¼ŒD2 å¼‚å¸¸ä¸æé†’è¦†ç›–ã€‚</li>
              <li>äº¤ä»˜ç‰©ï¼šPRDã€æ ·ä¾‹è‰ç¨¿ã€æœ¬åœ°åŸå‹é“¾æ¥ã€‚</li>
            </ul>

            <h3>é£é™©ä¸ä¾èµ–ï¼ˆå¯é€‰ï¼‰</h3>
            <ul>
              <li>é£é™©ï¼šç¨æ³•æ›´æ–°å¯¼è‡´é¢„ä¼°åå·®ï¼›ç”¨æˆ·è¯¯è§£ä¸ºç¨åŠ¡å»ºè®®ã€‚</li>
              <li>ä¾èµ–ï¼šOCR ä¸ç¨ç‡é…ç½®çš„ç¨³å®šæ€§ã€‚</li>
            </ul>

            <h3>å…³é”®å‡è®¾ä¸éªŒè¯è®¡åˆ’ï¼ˆå¯é€‰ï¼‰</h3>
            <ul>
              <li>å‡è®¾ï¼šç”¨æˆ·æ„¿æ„ä¸ºåˆè§„æé†’ä¸ç”³æŠ¥æ•ˆç‡ä»˜è´¹ã€‚</li>
              <li>éªŒè¯ï¼šç”³æŠ¥å­£å†…å°èŒƒå›´ç”¨æˆ·è¯•ç”¨ä¸è®¿è°ˆã€‚</li>
            </ul>
          `;
        }

        return `
          <h3>éœ€æ±‚èƒŒæ™¯</h3>
          <p class="muted">å›´ç»•â€œ${shortText}â€ï¼Œç›®æ ‡ç”¨æˆ·éœ€è¦æ›´é«˜æ•ˆã€æ›´ä¸€è‡´çš„è§£å†³æ–¹æ¡ˆï¼Œä»¥é™ä½æ²Ÿé€šä¸æ‰§è¡Œæˆæœ¬ã€‚</p>

          <h3>é¡¹ç›®å®šä½åŠå‘å±•æ–¹å‘</h3>
          <ul>
            <li>å®šä½ï¼šèšç„¦â€œ${shortText}â€çš„å‚ç›´å·¥å…·ã€‚</li>
            <li>å‘å±•æ–¹å‘ï¼šä» MVP éªŒè¯æ‰©å±•åˆ°æ›´å¤šæ¨¡æ¿ä¸åœºæ™¯ã€‚</li>
          </ul>

          <h3>ç›®æ ‡ä¸æŒ‡æ ‡ï¼ˆå£å¾„ï¼‰</h3>
          <ul>
            <li>åŒ—ææ˜ŸæŒ‡æ ‡ï¼šç›®æ ‡ç”¨æˆ·å®Œæˆå…³é”®åŠ¨ä½œçš„è½¬åŒ–ç‡ã€‚</li>
            <li>æ ¸å¿ƒæŒ‡æ ‡ï¼ˆ1-3 ä¸ªï¼‰ï¼šæ´»è·ƒç”¨æˆ·æ•°ã€å…³é”®äº§å‡ºå®Œæˆç‡ã€ä»˜è´¹è½¬åŒ–ç‡ã€‚</li>
            <li>KPI ç»´åº¦æ‹†è§£ï¼ˆç¤ºä¾‹ï¼‰ï¼šå¢é•¿ / è½¬åŒ– / ç•™å­˜ / æ´»è·ƒ / æ”¶å…¥æˆæœ¬ã€‚</li>
            <li>å£å¾„è¯´æ˜ï¼šä»¥å…³é”®æµç¨‹å®Œæˆä¸ºç»Ÿè®¡å£å¾„ã€‚</li>
          </ul>

          <h3>éœ€æ±‚å¯è¡Œæ€§</h3>
          <ul>
            <li>æŠ€æœ¯å¯è¡Œï¼šåŸºäºç°æœ‰èƒ½åŠ›å¯å¿«é€Ÿå®ç°æ ¸å¿ƒæµç¨‹ã€‚</li>
            <li>èµ„æºå¯è¡Œï¼šä¼˜å…ˆå®ç°æœ€å°é—­ç¯ï¼Œæ§åˆ¶èŒƒå›´ã€‚</li>
          </ul>

          <h3>ç›®æ ‡ç”¨æˆ·ä¸æ ¸å¿ƒåœºæ™¯</h3>
          <ul>
            <li>ç›®æ ‡ç”¨æˆ·ï¼š${escapeHtml(user)}</li>
            <li>æ ¸å¿ƒåœºæ™¯ï¼šå›´ç»•â€œ${shortText}â€å®Œæˆå…³é”®ä»»åŠ¡ã€‚</li>
          </ul>

          <h3>MVP éœ€æ±‚èŒƒå›´</h3>
          <ul>
            <li>åšï¼šå›´ç»•æ ¸å¿ƒæµç¨‹çš„è¾“å…¥ã€å¤„ç†ä¸è¾“å‡ºã€‚</li>
            <li>ä¸åšï¼šå¤šç«¯åä½œã€é«˜çº§åˆ†æã€å¤æ‚æƒé™ä½“ç³»ã€‚</li>
          </ul>

          <h3>æ ¸å¿ƒæµç¨‹ä¸åŠŸèƒ½éœ€æ±‚</h3>
          <ul>
            <li>æµç¨‹é—­ç¯ï¼šè¾“å…¥ä¿¡æ¯ â†’ ç”Ÿæˆç»“æ„åŒ–å†…å®¹ â†’ è¾“å‡ºå¯äº¤ä»˜ç»“æœã€‚</li>
            <li>åŠŸèƒ½éœ€æ±‚ï¼šå†…å®¹ç”Ÿæˆã€ç»“æœå¯¼å‡ºã€å†å²ç®¡ç†ã€‚</li>
          </ul>

          <h3>UI ä¸äº¤äº’éœ€æ±‚ï¼ˆiOS ç»„ä»¶åº“ï¼‰</h3>
          <p class="muted">åˆ†æ­¥å±•ç¤ºä¸æ¸…æ™°åé¦ˆï¼Œè¦†ç›–åŠ è½½/ç©º/é”™è¯¯/æˆåŠŸçŠ¶æ€ã€‚</p>

          <h3>ç‰ˆæœ¬è§„åˆ’ä¸é‡Œç¨‹ç¢‘</h3>
          <ul>
            <li>V0ï¼ˆMVPï¼‰èŒƒå›´ï¼šæ ¸å¿ƒæµç¨‹é—­ç¯ã€‚</li>
            <li>V1ï¼ˆæ‰©å±•ï¼‰èŒƒå›´ï¼šæ¨¡æ¿å¢å¼ºä¸è¡Œä¸šåŒ–ã€‚</li>
            <li>é‡Œç¨‹ç¢‘ï¼šD1 æ ¸å¿ƒæµç¨‹ï¼ŒD2 çŠ¶æ€ä¸è§„èŒƒè¡¥é½ã€‚</li>
            <li>äº¤ä»˜ç‰©ï¼šPRDã€æ ·ä¾‹ã€åŸå‹é“¾æ¥ã€‚</li>
          </ul>

          <h3>é£é™©ä¸ä¾èµ–ï¼ˆå¯é€‰ï¼‰</h3>
          <ul>
            <li>é£é™©ï¼šç›®æ ‡ç”¨æˆ·å¯¹â€œ${shortText}â€ä»·å€¼è®¤çŸ¥ä¸è¶³ã€‚</li>
            <li>ä¾èµ–ï¼šå†…å®¹ç”Ÿæˆèƒ½åŠ›ä¸æ¨¡æ¿è´¨é‡ã€‚</li>
          </ul>

          <h3>å…³é”®å‡è®¾ä¸éªŒè¯è®¡åˆ’ï¼ˆå¯é€‰ï¼‰</h3>
          <ul>
            <li>å‡è®¾ï¼š${escapeHtml(goal)}å¯¼å‘çš„ä»·å€¼ä¸»å¼ æˆç«‹ã€‚</li>
            <li>éªŒè¯ï¼šé€šè¿‡å°èŒƒå›´ç”¨æˆ·æµ‹è¯•ä¸è®¿è°ˆéªŒè¯ã€‚</li>
          </ul>
        `;
      }

      function renderDocs(project) {
        if (!project) return;
        if (ideaDocEl) ideaDocEl.innerHTML = buildIdeaEnhanced(project);
        if (prdDocEl) prdDocEl.innerHTML = buildPrd(project);
        updatePrototypeUI(project);
      }

      // --- Navigation ---
      function setActiveScreen(id) {
        screens.forEach((screen) => {
          screen.classList.toggle('active', screen.id === id);
          if (screen.id === id && id === 'dashboard') {
            renderProjects();
          }
        });
        document.querySelectorAll('.nav-item').forEach((item) => {
          item.classList.toggle('active', item.dataset.screen === id);
        });
      }

      navItems.forEach((item) => {
        item.addEventListener('click', () => {
          setActiveScreen(item.dataset.screen);
        });
      });

      // --- Auth ---
      function setLoggedIn(loggedIn) {
        state.user = loggedIn ? { email: 'demo@pmagent.ai' } : null;
        authView.classList.toggle('hidden', loggedIn);
        appShell.classList.toggle('hidden', !loggedIn);
        topActions.classList.toggle('hidden', !loggedIn);
        if (loggedIn) {
          renderProjects();
          setActiveScreen('dashboard');
        }
      }

      document.getElementById('login-btn').addEventListener('click', () => setLoggedIn(true));
      document.getElementById('logout').addEventListener('click', () => setLoggedIn(false));

      // --- Google Sign-In Handler ---
      window.handleCredentialResponse = function(response) {
        try {
          // Decode the JWT ID Token
          const responsePayload = decodeJwtResponse(response.credential);
          
          console.log("ID: " + responsePayload.sub);
          console.log('Full Name: ' + responsePayload.name);
          console.log('Given Name: ' + responsePayload.given_name);
          console.log('Family Name: ' + responsePayload.family_name);
          console.log("Image URL: " + responsePayload.picture);
          console.log("Email: " + responsePayload.email);

          // Update state with Google User info
          state.user = {
            email: responsePayload.email,
            name: responsePayload.name,
            avatar: responsePayload.picture
          };

          // Simulate login success
          setLoggedIn(true);
          
          // Optional: Update UI to show user avatar instead of generic login
          // (Requires adding an avatar element to the UI, omitted for MVP simplicity)

        } catch (e) {
          console.error('Error decoding Google token', e);
        }
      };

      function decodeJwtResponse(token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      }

      // --- Project Management ---
      function renderProjects() {
        projectListEl.innerHTML = '';
        navRecentEl.innerHTML = '';

        if (state.projects.length === 0) {
          projectListEl.classList.add('hidden');
          emptyStateEl.classList.remove('hidden');
          return;
        }

        projectListEl.classList.remove('hidden');
        emptyStateEl.classList.add('hidden');

        // Sort by newest
        const sorted = [...state.projects].sort((a, b) => b.id - a.id);

        sorted.forEach(p => {
          // Dashboard List Item
          const item = document.createElement('div');
          item.className = 'list-item';
          item.innerHTML = `
            <div>
              <div style="font-weight:500">${p.title}</div>
              <div class="muted">${p.date} Â· ${p.desc.substring(0, 20)}...</div>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
               ${p.status === 'processing' ? '<span class="tag processing">ç”Ÿæˆä¸­</span>' : '<span class="tag success">å·²å®Œæˆ</span>'}
               <button class="btn" onclick="openProject(${p.id})">æŸ¥çœ‹</button>
            </div>
          `;
          projectListEl.appendChild(item);

          // Nav Item
          const navItem = document.createElement('button');
          navItem.className = 'nav-item';
          navItem.style.fontSize = '13px';
          navItem.textContent = p.title;
          navItem.onclick = () => openProject(p.id);
          navRecentEl.appendChild(navItem);
        });
      }

      window.openProject = function(id) {
        const project = state.projects.find(p => p.id === id);
        if (!project) return;
        
        document.getElementById('result-project-title').textContent = project.title;
        renderDocs(project);
        
        // Reset View for Simulation
        document.getElementById('generation-progress').classList.add('hidden');
        document.getElementById('result-content').classList.remove('hidden');
        document.getElementById('result-status-tag').textContent = project.status === 'processing' ? 'ç”Ÿæˆä¸­' : 'å·²å®Œæˆ';
        document.getElementById('result-status-tag').className = project.status === 'processing' ? 'tag processing' : 'tag success';

        setActiveScreen('results');
      };

      // --- Generation Logic ---
      document.getElementById('generate-btn').addEventListener('click', () => {
        const idea = document.getElementById('idea-input').value;
        if (!idea) return alert('è¯·è¾“å…¥ Idea');
        const contextUser = document.getElementById('context-user').value;
        const contextCompetitors = document.getElementById('context-competitors').value;
        const contextGoal = document.getElementById('context-goal').value;

        // Token Check
        if (state.tokenBalance < 10) {
          paywall.classList.add('active');
          return;
        }

        // Deduct Token
        state.tokenBalance -= 10;
        updateTokenUI();

        // Create Project
        const newProject = {
          id: Date.now(),
          title: idea.substring(0, 10) + (idea.length > 10 ? '...' : ''),
          desc: idea,
          status: 'processing',
          date: 'åˆšåˆš',
          ideaInput: idea,
          context: {
            user: contextUser,
            competitors: contextCompetitors,
            goal: contextGoal
          }
        };
        state.projects.push(newProject);

        // UI Transition
        setActiveScreen('results');
        document.getElementById('result-project-title').textContent = newProject.title;
        document.getElementById('result-content').classList.add('hidden');
        document.getElementById('generation-progress').classList.remove('hidden');
        document.getElementById('result-status-tag').textContent = 'ç”Ÿæˆä¸­...';

        // Simulate Streaming
        const bar = document.getElementById('progress-bar');
        const text = document.getElementById('progress-text');
        
        setTimeout(() => { bar.style.width = '30%'; text.textContent = 'æ­£åœ¨å®Œå–„äº§å“æ„æƒ³...'; }, 500);
        setTimeout(() => { bar.style.width = '60%'; text.textContent = 'æ­£åœ¨æ’°å†™ PRD (MVP Scope)...'; }, 1500);
        setTimeout(() => { bar.style.width = '90%'; text.textContent = 'æ­£åœ¨ç¼–å†™æœ¬åœ° HTML åŸå‹ä»£ç ...'; }, 2500);
        setTimeout(() => { 
          bar.style.width = '100%'; 
          newProject.status = 'completed';
          document.getElementById('generation-progress').classList.add('hidden');
          document.getElementById('result-content').classList.remove('hidden');
          document.getElementById('result-status-tag').textContent = 'å·²å®Œæˆ';
          document.getElementById('result-status-tag').className = 'tag success';
          renderDocs(newProject);
          renderProjects(); // Update sidebar
        }, 3500);
      });

      function updateTokenUI() {
        tokenDisplay.textContent = state.tokenBalance;
        tokenDisplayMini.textContent = state.tokenBalance;
      }

      // --- Tabs ---
      document.querySelectorAll('[data-tab]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          const group = btn.dataset.tabGroup;
          document.querySelectorAll(`[data-tab-group="${group}"]`).forEach((b) => b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll(`[data-tab-panel-group="${group}"]`).forEach((panel) => {
            panel.classList.toggle('hidden', panel.dataset.tabPanel !== tab);
          });
        });
      });

      // --- Paywall ---
      document.querySelectorAll('[data-close]').forEach((btn) => {
        btn.addEventListener('click', () => {
          document.getElementById(btn.dataset.close).classList.remove('active');
        });
      });

      // --- Theme Toggle ---
      const themeToggleBtn = document.getElementById('theme-toggle');
      const htmlEl = document.documentElement;
      
      // Load saved theme
      const savedTheme = localStorage.getItem('theme') || 'light';
      htmlEl.setAttribute('data-theme', savedTheme);

      themeToggleBtn.addEventListener('click', () => {
        const current = htmlEl.getAttribute('data-theme');
        const next = current === 'light' ? 'dark' : 'light';
        htmlEl.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
      });

      // Init
      setLoggedIn(false);
      updateTokenUI();
    </script>
  </body>
</html>
